<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 8.0.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"hoshea99.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.25.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script><meta name="description" content="针对C++的程序，在CPU、内存等性能优化方面实战如何操作（描述）？本文将进行逐步完善。"><meta property="og:type" content="article"><meta property="og:title" content="软件优化问题排查实战"><meta property="og:url" content="https://hoshea99.github.io/2025/12/10/%E8%BD%AF%E4%BB%B6%E4%BC%98%E5%8C%96%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E5%AE%9E%E6%88%98/index.html"><meta property="og:site_name" content="Hoshea&#39;s Blog"><meta property="og:description" content="针对C++的程序，在CPU、内存等性能优化方面实战如何操作（描述）？本文将进行逐步完善。"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2025-12-10T00:43:00.000Z"><meta property="article:modified_time" content="2025-12-10T08:53:33.865Z"><meta property="article:author" content="Hoshea"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://hoshea99.github.io/2025/12/10/%E8%BD%AF%E4%BB%B6%E4%BC%98%E5%8C%96%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E5%AE%9E%E6%88%98/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://hoshea99.github.io/2025/12/10/%E8%BD%AF%E4%BB%B6%E4%BC%98%E5%8C%96%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E5%AE%9E%E6%88%98/","path":"2025/12/10/软件优化问题排查实战/","title":"软件优化问题排查实战"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>软件优化问题排查实战 | Hoshea's Blog</title><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script><script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script><script src="/js/third-party/search/local-search.js" defer></script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Hoshea's Blog</p><i class="logo-line"></i></a></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98"><span class="nav-number">1.</span> <span class="nav-text">内存问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E5%96%84%E5%89%8D%E5%9B%9E%E7%AD%94"><span class="nav-number">1.1.</span> <span class="nav-text">完善前回答</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E5%96%84%E5%90%8E%E5%9B%9E%E7%AD%94"><span class="nav-number">1.2.</span> <span class="nav-text">完善后回答</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CPU%E9%97%AE%E9%A2%98"><span class="nav-number">2.</span> <span class="nav-text">CPU问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E5%96%84%E5%89%8D%E5%9B%9E%E7%AD%94-1"><span class="nav-number">2.1.</span> <span class="nav-text">完善前回答</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E5%96%84%E5%90%8E%E5%9B%9E%E7%AD%94-1"><span class="nav-number">2.2.</span> <span class="nav-text">完善后回答</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">Hoshea</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">56</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><span class="site-state-item-count">8</span> <span class="site-state-item-name">分类</span></div></nav></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://hoshea99.github.io/2025/12/10/%E8%BD%AF%E4%BB%B6%E4%BC%98%E5%8C%96%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E5%AE%9E%E6%88%98/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="Hoshea"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Hoshea's Blog"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="软件优化问题排查实战 | Hoshea's Blog"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">软件优化问题排查实战</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2025-12-10 08:43:00 / 修改时间：16:53:33" itemprop="dateCreated datePublished" datetime="2025-12-10T08:43:00+08:00">2025-12-10</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>针对C++的程序，在CPU、内存等性能优化方面实战如何操作（描述）？本文将进行逐步完善。</p><span id="more"></span><h1 id="内存问题"><a href="#内存问题" class="headerlink" title="内存问题"></a>内存问题</h1><blockquote><p>C++程序遇到疑似内存问题应该如何排查？</p></blockquote><h2 id="完善前回答"><a href="#完善前回答" class="headerlink" title="完善前回答"></a>完善前回答</h2><p>在基础场景下，最多只能算合格。</p><blockquote><p>首先使用vmstat初测，看一下free内存是否在急速下降，si&#x2F;so是否大于0，如果是，则代表确实是可能存在内存问题。接着使用pmap指令，看一下内存申请记录，如果发现较多相同大小指令申请，则有可能是缓冲区申请过多，考虑使用内存池优化。如果正常，再去用valgrind进行进一步的内存泄漏分析，具体到申请行，泄露了多少字节。</p></blockquote><p>存在的问题点：</p><ol><li><p>vmstat只能证明你的系统内存紧张，只能证明系统内存不够用了，不能直接证明是我的C++程序泄露，也有可能是其他程序在抢内存</p><p>修改：</p><p>先用top指令锁定具体进程，确认是该进程的RES一直在涨</p></li><li><p>pmap不能看代码层面的申请记录，只能看到进程内存段的映射情况</p><p>修改：</p><p>pmap用来查看是否有大量的64MB匿名映射快，来判断是否是堆内存一直在增长</p></li><li><p>valgrind没有问题，但是他不适合在生产环节使用，因为会降低程序运行速度，在实际问题排查时，需要分线上和线下两种情况。</p></li></ol><h2 id="完善后回答"><a href="#完善后回答" class="headerlink" title="完善后回答"></a>完善后回答</h2><ol><li><p>线上初步观测定位</p><p><strong>如果是线上环境，首先要确定是否真的存在泄露。</strong></p><p>所以我先用top -p [PID]观察RES（物理内存）是否呈线性持续增长，疑似泄露。</p><p>然后用pmap内存段分析，看看匿名内存段是否有很多64MB倍数的映射块（代表glibc的内存分配特征），如果有的话则代表申请了较多堆内存且没有释放。</p><p>如果想要在线上看到泄露堆栈，可以考虑使用eBPF工具定位</p></li><li><p>线下复现</p><p><strong>如果是线下环境可以复现，可以使用到更详细的工具</strong></p><p>使用valgrind进行全面检查，分析到具体到代码行的问题，还可以查到崩溃问题（内存越界）</p></li></ol><blockquote><p>预防追问：测试环境复现不出来，线上环境比较老旧用不了eBPF，如何定位？</p></blockquote><blockquote><p>极端情况下，使用gdb在现场对进程进行coredump，拉回本地使用gdb打开具体分析内存中残留对象的内容。</p></blockquote><h1 id="CPU问题"><a href="#CPU问题" class="headerlink" title="CPU问题"></a>CPU问题</h1><blockquote><p>C++程序遇到疑似CPU问题应该如何排查？</p></blockquote><h2 id="完善前回答-1"><a href="#完善前回答-1" class="headerlink" title="完善前回答"></a>完善前回答</h2><blockquote><p>首先，我使用top指令，观察是us、sy和wa，区分到底是用户态代码耗时过长，还是系统调用耗时过长，还是等待IO过久。<br>其次，我再使用mpstat指令，看是单核爆了，还是每个核心都满，如果是单核爆了，则考虑代码是否存在多线程分配只分配给一个线程的问题<br>然后，如果是每个核心都很久，首先看是否是us过高，us高则去使用pidstat，观察是主动放弃时间片多还是被动放弃时间片。主动多，则代表锁的粒度过高，或者IO过于频繁，被动多，则代表用户代码计算量过大，总是被抢走时间片。被动多的话，使用perf record结合火焰图看耗时最高的函数，进行定，也可以通过perf确认是缓存miss还是分支预测失败。 如果是sy过高，则代表系统调用过多，锁粒度或者IO读取频率过高<br>最后，如果火焰图查出来具体函数，如果是sy高，则返回去看vmstat，如果wa高则去看IO，如果不是，则去使用strace看调用次数，看是锁的接口调用得多还是IO函数调用得多</p></blockquote><p>存在的问题点：</p><ol><li>把核心工具都列出来了，但是很绕，尤其是最后pidstat，perf和strace</li></ol><h2 id="完善后回答-1"><a href="#完善后回答-1" class="headerlink" title="完善后回答"></a>完善后回答</h2><p>让逻辑不乱，也是以top的指标为核心，展开排查路径。</p><ol><li>先用top指令查看CPU整体负载，看us（用户态）、sy（内核态）、wa（IO等待）三个指标去决定后面的排查方法。</li><li>如果是us高<ol><li>我则去使用mpstat看是否存在单核瓶颈。<strong>如果是单核瓶颈</strong>，则考虑要么是某个死循环卡死了单线程，或者是线程一直绑定在一个CPU上。如果是多核均匀高，则说明确实存在计算压力大的问题。</li><li>无论是单核还是多核，我都会用perf+FrameGraph生成火焰图，去定位具体哪个函数平顶，CPU占用又高又久。</li></ol></li><li>如果sy高，则代表和OS交互频繁。使用pidstat区分是什么种类的上下文切换<ol><li>如果是非自愿切换高，则代表是线程太多了，CPU时间片不够分。需要检查线程池配置，减少线程。</li><li>如果是自愿切换高，则代表主动让出CPU（锁竞争、IO等待较多），使用strace查看系统调用频次，看是futex多就需要查看锁粒度，如果是read、write、epoll高则代表io次数太多。</li><li>如果切换不高，但是sy就是高，就说明就是系统调用比较密集，比如疯狂调用read读取小字节，或者在循环里获取时间。这时候需要用strace查看系统调用的次数，哪个格外多就进行优化。</li></ol></li><li>如果是wa高，说明是CPU在等IO完成，直接用iotop抓出读写磁盘最狠的线程即可。</li><li>如果都没问题，但是IPC（每循环指令数）很低，可以使用perf stat进行查看什么原因<ol><li>cache misses ：是不是比访问数据频繁使用链表而不是数组，或者是struct结构不行，因为要对齐</li><li>branch missed：大量的分支预测失败，比如过多的if或switch</li></ol></li></ol></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-item"><a href="/2025/12/08/Linux%E8%B0%83%E8%AF%95%E7%BB%8F%E9%AA%8C%E5%8D%87%E7%BA%A7%E7%89%88/" rel="prev" title="Linux调试经验升级版"><i class="fa fa-angle-left"></i> Linux调试经验升级版</a></div><div class="post-nav-item"><a href="/2025/12/20/enable-if%E5%92%8Cvoid-t/" rel="next" title="enable_if和void_t">enable_if和void_t <i class="fa fa-angle-right"></i></a></div></div></footer></article></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Hoshea</span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动</div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>